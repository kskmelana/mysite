<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>भू-नक्शा CCE (1 क्लिक Auto)</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --blue:#1e66ff;
      --red:#ff2d2d;
      --txt:#111;
      --muted:#666;
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      overflow:auto; /* ✅ scroll enabled */
      background:var(--bg);
      font-family: system-ui, Arial, sans-serif;
      color:var(--txt);
    }

    .app{
      min-height:100vh;
      width:100%;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
    }

    .topbar{
      background:var(--card);
      border:1px solid rgba(0,0,0,0.08);
      border-radius:16px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }

    .title{
      font-weight:900;
      font-size:16px;
      line-height:1.1;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      line-height:1.3;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      background:#eef1ff;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{ background:#5166ff; color:white; }
    .btn.danger{ background:#ffecec; color:#b40000; }

    .mid{
      flex: 0 0 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel{
      background:var(--card);
      border:1px solid rgba(0,0,0,0.08);
      border-radius:16px;
      padding:10px;
      flex: 0 0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      margin-bottom:6px;
      color:#222;
    }

    input[type="number"], input[type="file"]{
      width:100%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid #ddd;
      font-size:14px;
      outline:none;
      background:#fafafa;
    }

    .miniBtns{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    .canvasWrap{
      flex: 0 0 auto;
      min-height:0;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.12);
      background:#111;
      position:relative;
      max-height:65vh;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      background:#111;
    }

    .tip{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      background:rgba(0,0,0,0.55);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      line-height:1.35;
      backdrop-filter: blur(6px);
    }

    .result{
      background:var(--card);
      border:1px solid rgba(0,0,0,0.08);
      border-radius:16px;
      padding:10px;
      flex: 0 0 auto;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:7px 0;
      border-bottom:1px dashed rgba(0,0,0,0.08);
      font-size:13px;
    }
    .row:last-child{ border-bottom:none; }
    .val{ font-weight:900; }

    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#f1f5ff;
      border:1px solid #d7e0ff;
      font-weight:900;
      color:#2a3cff;
      margin-left:8px;
    }

    .warn{
      color:#b40000;
      font-weight:900;
    }
  </style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div>
      <div class="title">भू-नक्शा CCE Auto <span class="badge">1 क्लिक</span> <span class="badge">1 कदम=0.75m</span></div>
      <div class="sub">
        1) Screenshot Upload करें  2) हेक्टेयर डालें  3) खेत के अंदर 1 क्लिक करें
      </div>
    </div>
    <button class="btn danger" id="btnReset">Reset</button>
  </div>

  <div class="mid">

    <div class="panel">
      <div class="grid">
        <div>
          <label>Screenshot Upload</label>
          <input id="file" type="file" accept="image/*" />
        </div>
        <div>
          <label>खेत का एरिया (हेक्टेयर)</label>
          <input id="haInput" type="number" inputmode="decimal" step="0.0001" placeholder="उदाहरण: 1.7100" />
        </div>
      </div>

      <div class="miniBtns">
        <button class="btn" id="btnClearPick">Clear Pick</button>
        <button class="btn primary" id="btnRecalc">Re-Calculate</button>
      </div>
    </div>

    <div class="canvasWrap">
      <canvas id="cv"></canvas>
      <div class="tip" id="tip">
        फोटो अपलोड करें → हेक्टेयर डालें → ग्रे खेत के अंदर 1 क्लिक करें।
      </div>
    </div>

    <div class="result">
      <div class="row"><div>लंबाई (मीटर)</div><div class="val" id="outLenM">0</div></div>
      <div class="row"><div>चौड़ाई (मीटर)</div><div class="val" id="outWidM">0</div></div>
      <div class="row"><div>लंबाई (कदम)</div><div class="val" id="outLenS">0</div></div>
      <div class="row"><div>चौड़ाई (कदम)</div><div class="val" id="outWidS">0</div></div>
      <div class="row"><div>एरिया (m²)</div><div class="val" id="outSqm">0</div></div>
      <div class="row"><div>एरिया (हेक्टेयर)</div><div class="val" id="outHa">0</div></div>
      <div class="row"><div>Status</div><div class="val" id="outStatus">Waiting...</div></div>
    </div>

  </div>
</div>

<script>
  // Fixed
  const STEP_METER = 0.75;

  // Flood fill tuning:
  // If your screenshots vary, you can adjust these 2 values.
  const COLOR_TOLERANCE = 38; // 25-55 recommended
  const MAX_PIXELS = 350000;  // safety limit for mobile

  // Elements
  const file = document.getElementById("file");
  const haInput = document.getElementById("haInput");

  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d", { willReadFrequently: true });

  const btnReset = document.getElementById("btnReset");
  const btnClearPick = document.getElementById("btnClearPick");
  const btnRecalc = document.getElementById("btnRecalc");
  const tip = document.getElementById("tip");

  // Outputs
  const outLenM = document.getElementById("outLenM");
  const outWidM = document.getElementById("outWidM");
  const outLenS = document.getElementById("outLenS");
  const outWidS = document.getElementById("outWidS");
  const outSqm = document.getElementById("outSqm");
  const outHa = document.getElementById("outHa");
  const outStatus = document.getElementById("outStatus");

  // State
  let img = new Image();
  let imgLoaded = false;

  // Pick
  let pick = null; // {x,y}
  let bbox = null; // {minX,minY,maxX,maxY}
  let overlayMask = null; // Uint8Array 0/1

  function resetAll(){
    pick = null;
    bbox = null;
    overlayMask = null;
    haInput.value = "";
    update();
    tip.innerHTML = "Reset हो गया। फोटो अपलोड करें → हेक्टेयर डालें → खेत के अंदर 1 क्लिक करें।";
    outStatus.textContent = "Waiting...";
  }

  btnReset.onclick = resetAll;

  btnClearPick.onclick = () => {
    pick = null;
    bbox = null;
    overlayMask = null;
    update();
    outStatus.textContent = "Pick cleared. अब खेत के अंदर क्लिक करें।";
  };

  btnRecalc.onclick = () => {
    if(!pick){
      outStatus.textContent = "पहले खेत के अंदर क्लिक करें।";
      return;
    }
    runAutoPick(pick.x, pick.y);
  };

  // Image load
  file.addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(!f) return;

    const url = URL.createObjectURL(f);
    img = new Image();
    img.onload = () => {
      imgLoaded = true;

      // Canvas = image size
      cv.width = img.naturalWidth;
      cv.height = img.naturalHeight;

      pick = null;
      bbox = null;
      overlayMask = null;

      update();
      outStatus.textContent = "Photo loaded. खेत के अंदर क्लिक करें।";
    };
    img.src = url;
  });

  function getCanvasPos(evt){
    const rect = cv.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

    const x = (clientX - rect.left) * (cv.width / rect.width);
    const y = (clientY - rect.top) * (cv.height / rect.height);
    return {x: Math.round(x), y: Math.round(y)};
  }

  function fmt(n, d=2){
    if(!isFinite(n) || n <= 0) return "0";
    return Number(n).toFixed(d);
  }

  function distRGB(r1,g1,b1, r2,g2,b2){
    const dr = r1-r2, dg=g1-g2, db=b1-b2;
    return Math.sqrt(dr*dr + dg*dg + db*db);
  }

  function runAutoPick(px, py){
    const ha = parseFloat(haInput.value);
    if(!isFinite(ha) || ha <= 0){
      outStatus.innerHTML = "<span class='warn'>पहले हेक्टेयर डालें।</span>";
      return;
    }
    if(!imgLoaded){
      outStatus.innerHTML = "<span class='warn'>पहले फोटो अपलोड करें।</span>";
      return;
    }

    outStatus.textContent = "Processing...";
    update(); // draw

    // Read pixels
    const imgData = ctx.getImageData(0,0,cv.width,cv.height);
    const data = imgData.data;
    const w = cv.width, h = cv.height;

    // seed color
    const idx0 = (py*w + px)*4;
    const sr = data[idx0], sg = data[idx0+1], sb = data[idx0+2];

    // BFS flood fill with tolerance
    const visited = new Uint8Array(w*h);
    const mask = new Uint8Array(w*h);

    const qx = new Int32Array(Math.min(w*h, MAX_PIXELS));
    const qy = new Int32Array(Math.min(w*h, MAX_PIXELS));
    let qh=0, qt=0;

    function push(x,y){
      qx[qt]=x; qy[qt]=y; qt++;
    }

    push(px,py);
    visited[py*w+px]=1;

    let minX=px, maxX=px, minY=py, maxY=py;
    let count=0;

    while(qh < qt){
      const x = qx[qh], y = qy[qh]; qh++;
      const p = y*w + x;

      const ii = p*4;
      const r = data[ii], g = data[ii+1], b = data[ii+2];

      const d = distRGB(r,g,b, sr,sg,sb);

      if(d <= COLOR_TOLERANCE){
        mask[p]=1;
        count++;

        if(x<minX) minX=x;
        if(x>maxX) maxX=x;
        if(y<minY) minY=y;
        if(y>maxY) maxY=y;

        // safety
        if(count >= MAX_PIXELS) break;

        // 4-neighbors
        if(x>0){
          const p2 = p-1;
          if(!visited[p2]){ visited[p2]=1; push(x-1,y); }
        }
        if(x<w-1){
          const p2 = p+1;
          if(!visited[p2]){ visited[p2]=1; push(x+1,y); }
        }
        if(y>0){
          const p2 = p-w;
          if(!visited[p2]){ visited[p2]=1; push(x,y-1); }
        }
        if(y<h-1){
          const p2 = p+w;
          if(!visited[p2]){ visited[p2]=1; push(x,y+1); }
        }
      }
    }

    if(count < 2000){
      outStatus.innerHTML = "<span class='warn'>खेत detect नहीं हुआ। ग्रे के अंदर सही क्लिक करें।</span>";
      overlayMask = null;
      bbox = null;
      update();
      return;
    }

    overlayMask = mask;
    bbox = {minX, minY, maxX, maxY, count};

    // Now compute ratio from bbox (rectangle approx)
    const lp = (maxY - minY); // vertical pixels
    const wp = (maxX - minX); // horizontal pixels

    if(lp <= 5 || wp <= 5){
      outStatus.innerHTML = "<span class='warn'>BBox बहुत छोटा आया। दुबारा क्लिक करें।</span>";
      overlayMask = null;
      bbox = null;
      update();
      return;
    }

    // ratio from map
    let ratio = lp / wp;

    // real area
    const areaSqm = ha * 10000;

    // solve rectangle dims
    let Wm = Math.sqrt(areaSqm / ratio);
    let Lm = ratio * Wm;

    // auto swap: length bigger
    if(Wm > Lm){
      const t = Wm; Wm = Lm; Lm = t;
      ratio = 1/ratio;
    }

    const Lsteps = Lm / STEP_METER;
    const Wsteps = Wm / STEP_METER;

    // rounded steps
    const LsR = Math.round(Lsteps);
    const WsR = Math.round(Wsteps);

    // output
    outLenM.textContent = fmt(Lm,2) + " m";
    outWidM.textContent = fmt(Wm,2) + " m";
    outLenS.textContent = LsR + " कदम";
    outWidS.textContent = WsR + " कदम";
    outSqm.textContent = fmt(areaSqm,2) + " m²";
    outHa.textContent = fmt(ha,4) + " ha";

    outStatus.textContent = "Done ✔ (Auto detect)";
    update();
  }

  function drawOverlay(){
    if(!overlayMask || !bbox) return;

    const w = cv.width, h = cv.height;
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;

    // Tint mask
    for(let y=bbox.minY; y<=bbox.maxY; y++){
      const row = y*w;
      for(let x=bbox.minX; x<=bbox.maxX; x++){
        const p = row + x;
        if(overlayMask[p]){
          const i = p*4;
          // green tint
          data[i] = Math.min(255, data[i] + 0);
          data[i+1] = Math.min(255, data[i+1] + 40);
          data[i+2] = Math.min(255, data[i+2] + 0);
        }
      }
    }
    ctx.putImageData(imgData,0,0);

    // Draw bbox rectangle
    ctx.lineWidth = 10;
    ctx.strokeStyle = "#00ff7a";
    ctx.strokeRect(bbox.minX, bbox.minY, (bbox.maxX-bbox.minX), (bbox.maxY-bbox.minY));

    // draw pick point
    if(pick){
      ctx.beginPath();
      ctx.arc(pick.x, pick.y, 14, 0, Math.PI*2);
      ctx.fillStyle = "#00ff7a";
      ctx.fill();
      ctx.lineWidth = 4;
      ctx.strokeStyle = "white";
      ctx.stroke();
    }
  }

  function update(){
    ctx.clearRect(0,0,cv.width,cv.height);

    if(imgLoaded){
      ctx.drawImage(img,0,0);
      drawOverlay();
    } else {
      cv.width = 800;
      cv.height = 500;
      ctx.fillStyle = "#111";
      ctx.fillRect(0,0,cv.width,cv.height);
      ctx.fillStyle = "#fff";
      ctx.font = "28px system-ui";
      ctx.fillText("Screenshot Upload करें", 40, 80);
      return;
    }
  }

  function handlePick(pos){
    pick = pos;
    overlayMask = null;
    bbox = null;
    update();
    runAutoPick(pos.x, pos.y);
  }

  cv.addEventListener("click", (evt) => {
    if(!imgLoaded) return;
    handlePick(getCanvasPos(evt));
  });

  cv.addEventListener("touchstart", (evt) => {
    if(!imgLoaded) return;
    evt.preventDefault();
    handlePick(getCanvasPos(evt));
  }, {passive:false});

  haInput.addEventListener("input", () => {
    if(pick){
      runAutoPick(pick.x, pick.y);
    }
  });

  resetAll();
</script>

</body>
</html>
